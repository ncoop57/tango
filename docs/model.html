---

title: CNN

keywords: fastai
sidebar: home_sidebar

summary: "This module contains all the code for training and extracting features from CNNs."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/05_model.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="sift_frame_sim" class="doc_header"><code>sift_frame_sim</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L12" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>sift_frame_sim</code>(<strong><code>features_i</code></strong>, <strong><code>features_j</code></strong>, <strong><code>codebook</code></strong>, <strong><code>df</code></strong>, <strong><code>vw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="simclr_frame_sim" class="doc_header"><code>simclr_frame_sim</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>simclr_frame_sim</code>(<strong><code>features_i</code></strong>, <strong><code>features_j</code></strong>, <strong><code>codebook</code></strong>, <strong><code>df</code></strong>, <strong><code>vw</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SimCLRDataset" class="doc_header"><code>class</code> <code>SimCLRDataset</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L51" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SimCLRDataset</code>(<strong><code>dataset</code></strong>) :: <code>Dataset</code></p>
</blockquote>
<p>An abstract class representing a :class:<code>Dataset</code>.</p>
<p>All datasets that represent a map from keys to data samples should subclass
it. All subclasses should overwrite :meth:<code>__getitem__</code>, supporting fetching a
data sample for a given key. Subclasses could also optionally overwrite
:meth:<code>__len__</code>, which is expected to return the size of the dataset by many
:class:<code>~torch.utils.data.Sampler</code> implementations and the default options
of :class:<code>~torch.utils.data.DataLoader</code>.</p>
<p>.. note::
  :class:<code>~torch.utils.data.DataLoader</code> by default constructs a index
  sampler that yields integral indices.  To make it work with a map-style
  dataset with non-integral indices/keys, a custom sampler must be provided.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="imagenet_normalize_transform" class="doc_header"><code>imagenet_normalize_transform</code><a href="https://github.com/ncoop57/tango/tree/master/tango/features.py#L77" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>imagenet_normalize_transform</code>()</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_train_transforms" class="doc_header"><code>get_train_transforms</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L101" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_train_transforms</code>(<strong><code>size</code></strong>=<em><code>224</code></em>, <strong><code>color_jitter_prob</code></strong>=<em><code>0.8</code></em>, <strong><code>grayscale_prob</code></strong>=<em><code>0.2</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_val_transforms" class="doc_header"><code>get_val_transforms</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L113" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_val_transforms</code>(<strong><code>size</code></strong>=<em><code>224</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="NTXEntCriterion" class="doc_header"><code>class</code> <code>NTXEntCriterion</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L124" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>NTXEntCriterion</code>(<strong><code>temperature</code></strong>=<em><code>0.5</code></em>) :: <code>Module</code></p>
</blockquote>
<p>Normalized, temperature-scaled cross-entropy criterion, as suggested in the SimCLR paper.</p>
<p>Parameters:
    temperature (float, optional): temperature to scale the confidences. Defaults to 0.5.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="SimCLRModel" class="doc_header"><code>class</code> <code>SimCLRModel</code><a href="https://github.com/ncoop57/tango/tree/master/tango/model.py#L212" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>SimCLRModel</code>(<strong><code>model_name</code></strong>=<em><code>'resnet18'</code></em>, <strong><code>pretrained</code></strong>=<em><code>True</code></em>, <strong><code>projection_dim</code></strong>=<em><code>64</code></em>, <strong><code>temperature</code></strong>=<em><code>0.5</code></em>, <strong><code>batch_size</code></strong>=<em><code>128</code></em>, <strong><code>image_size</code></strong>=<em><code>224</code></em>, <strong><code>save_hparams</code></strong>=<em><code>True</code></em>) :: <code>LightningModule</code></p>
</blockquote>
<p>SimCLR training network for a generic torchvision model (restricted to <code>allowed_models</code>).</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Hook</span><span class="p">():</span>
    <span class="s2">&quot;Create a hook on `m` with `hook_func`.&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="n">hook_func</span><span class="p">:</span><span class="n">HookFunc</span><span class="p">,</span> <span class="n">is_forward</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">detach</span><span class="p">:</span><span class="nb">bool</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook_func</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">detach</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">stored</span> <span class="o">=</span> <span class="n">hook_func</span><span class="p">,</span><span class="n">detach</span><span class="p">,</span><span class="kc">None</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">register_forward_hook</span> <span class="k">if</span> <span class="n">is_forward</span> <span class="k">else</span> <span class="n">m</span><span class="o">.</span><span class="n">register_backward_hook</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hook</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hook_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">removed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">hook_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">:</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">,</span> <span class="nb">input</span><span class="p">:</span><span class="n">Tensors</span><span class="p">,</span> <span class="n">output</span><span class="p">:</span><span class="n">Tensors</span><span class="p">):</span>
        <span class="s2">&quot;Applies `hook_func` to `module`, `input`, `output`.&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detach</span><span class="p">:</span>
            <span class="nb">input</span>  <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">input</span> <span class="p">)</span> <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="nb">input</span> <span class="p">)</span> <span class="k">else</span> <span class="nb">input</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span> <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">output</span><span class="p">)</span> <span class="k">if</span> <span class="n">is_listy</span><span class="p">(</span><span class="n">output</span><span class="p">)</span> <span class="k">else</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stored</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hook_func</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Remove the hook from the model.&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">removed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hook</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">removed</span><span class="o">=</span><span class="kc">True</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">get_output</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">input_value</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">output</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_input</span><span class="p">(</span><span class="n">module</span><span class="p">,</span> <span class="n">input_value</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_value</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">get_named_module_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">m</span>
    <span class="k">return</span> <span class="kc">None</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">trainPetsModel</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Fine tunes a pretrained ResNet50 model to detect pet breeds </span>
<span class="sd">    and returns the resulting model in learn as well as the last layer</span>
<span class="sd">    in linear_output_layer for subsequent feature extraction.&#39;&#39;&#39;</span>
    
    <span class="n">bs</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">PETS</span><span class="p">)</span>
    <span class="n">path_img</span> <span class="o">=</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;images&#39;</span>
    <span class="n">fnames</span> <span class="o">=</span> <span class="n">get_image_files</span><span class="p">(</span><span class="n">path_img</span><span class="p">)</span>
    <span class="n">pat</span> <span class="o">=</span> <span class="n">pat</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;/([^/]+)_\d+.jpg$&#39;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_name_re</span><span class="p">(</span><span class="n">path_img</span><span class="p">,</span> <span class="n">fnames</span><span class="p">,</span> <span class="n">pat</span><span class="p">,</span> <span class="n">ds_tfms</span><span class="o">=</span><span class="n">get_transforms</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span>
                                  <span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">imagenet_stats</span><span class="p">)</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet34</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>

    <span class="n">linear_output_layer</span> <span class="o">=</span> <span class="n">get_named_module_from_model</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;1.4&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">learn</span><span class="p">,</span> <span class="n">linear_output_layer</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">getFeaturesResNet50</span><span class="p">(</span><span class="n">img</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Directly gets a feature vector from the last layer of ResNet50</span>
<span class="sd">    without any fine tuning.&#39;&#39;&#39;</span>
    
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">modules</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">children</span><span class="p">())[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">resNet50</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">modules</span><span class="p">)</span>
    <span class="n">imgVar</span> <span class="o">=</span> <span class="n">Variable</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="n">featuresVar</span> <span class="o">=</span> <span class="n">resNet50</span><span class="o">.</span><span class="n">eval</span><span class="p">()(</span><span class="n">imgVar</span><span class="p">)</span>
    <span class="n">features</span> <span class="o">=</span> <span class="n">featuresVar</span><span class="o">.</span><span class="n">data</span>
    
    <span class="k">return</span> <span class="n">features</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">trainAsModel</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Fine tunes a pretrained ResNet50 model to detect Google Play store  </span>
<span class="sd">    categories of Android screenshots and returns the resulting model in learn </span>
<span class="sd">    as well as the last layer in linear_output_layer for subsequent feature extraction.&#39;&#39;&#39;</span>
    
    <span class="n">bs</span> <span class="o">=</span> <span class="mi">16</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;/tf/GP-Labeled-Dataset/&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">ImageDataBunch</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ds_tfms</span><span class="o">=</span><span class="n">get_transforms</span><span class="p">(),</span> <span class="n">size</span><span class="o">=</span><span class="mi">299</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="n">bs</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">imagenet_stats</span><span class="p">)</span>
    <span class="n">learn</span> <span class="o">=</span> <span class="n">cnn_learner</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">error_rate</span><span class="p">)</span>
    <span class="n">learn</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;/tf/models/Android_ResNet50_16Epochs&#39;</span><span class="p">)</span>
    
    <span class="n">linear_output_layer</span> <span class="o">=</span> <span class="n">get_named_module_from_model</span><span class="p">(</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;1.4&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">learn</span><span class="p">,</span> <span class="n">linear_output_layer</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">Extractor</span><span class="p">():</span>
    
    <span class="sd">&#39;&#39;&#39;Low level implementation of Extractor class for non-layered models only.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">learn</span><span class="p">,</span> <span class="n">linear_output_layer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">isFT</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;resnet50&#39;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learn</span> <span class="o">=</span> <span class="n">learn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">linear_output_layer</span> <span class="o">=</span> <span class="n">linear_output_layer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">isFT</span> <span class="o">=</span> <span class="n">isFT</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid architecture: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">getFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;resnet50&#39;</span><span class="p">:</span>
            <span class="n">resized_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
        <span class="n">final_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">resized_img</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">final_img</span><span class="p">)</span>
        
        <span class="n">img_repr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">isFT</span><span class="p">:</span>
            <span class="n">floatTensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">Hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">linear_output_layer</span><span class="p">,</span> <span class="n">get_output</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">hook</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">learn</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()(</span><span class="n">floatTensor</span><span class="p">)</span>
                <span class="n">img_repr</span> <span class="o">=</span> <span class="n">hook</span><span class="o">.</span><span class="n">stored</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">floatTensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span>
            <span class="n">img_repr</span> <span class="o">=</span> <span class="n">getFeaturesResNet50</span><span class="p">(</span><span class="n">floatTensor</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">img_repr</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">class</span> <span class="nc">LayeredExtractor</span><span class="p">():</span>
    
    <span class="sd">&#39;&#39;&#39;Low level implementation of Extractor class for layered models only.&#39;&#39;&#39;</span>
    
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
    <span class="k">def</span> <span class="nf">hook_fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="nb">input</span><span class="p">,</span> <span class="n">output</span><span class="p">):</span>
        <span class="n">output_flat</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">,</span> <span class="n">output_flat</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">getFeatures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">img</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="n">resized_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="p">(</span><span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">))</span>
        <span class="n">final_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">resized_img</span><span class="p">,</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">final_img</span><span class="p">)</span>
        <span class="n">floatTensor</span> <span class="o">=</span> <span class="n">tensor</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">FloatTensor</span><span class="p">)</span>
        
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">named_modules</span><span class="p">():</span>
            <span class="k">if</span> <span class="s1">&#39;pool&#39;</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
                <span class="n">m</span><span class="o">.</span><span class="n">register_forward_hook</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hook_fn</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()(</span><span class="n">floatTensor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
    
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">createExtractor</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">linear_output_layer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">isFT</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Extractor</span><span class="p">(</span><span class="n">learn</span><span class="p">,</span> <span class="n">linear_output_layer</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">isFT</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">createLayeredExtractor</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">LayeredExtractor</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
</div>
 

